<?xml version="1.0" encoding="UTF-8"?>
<root>
  <src>
    <sourceType><![CDATA[web]]></sourceType>
    <sourceUrl><![CDATA[https://greg-butcher.livejournal.com/122967.html]]></sourceUrl>
    <sourceHost><![CDATA[localhost]]></sourceHost>
    <sourceUser><![CDATA[recipe]]></sourceUser>
    <sourcePass><![CDATA[g9NacKpPidGqCSq4]]></sourcePass>
    <sourceEncoding><![CDATA[utf-8]]></sourceEncoding>
    <sourceDB><![CDATA[]]></sourceDB>
    <sourceTable><![CDATA[]]></sourceTable>
  </src>
  <dst>
    <destinationType><![CDATA[sql]]></destinationType>
    <destinationUrl><![CDATA[]]></destinationUrl>
    <destinationHost><![CDATA[localhost]]></destinationHost>
    <destinationUser><![CDATA[recipe]]></destinationUser>
    <destinationPass><![CDATA[g9NacKpPidGqCSq4]]></destinationPass>
    <destinationEncoding><![CDATA[utf-8]]></destinationEncoding>
    <destinationDB><![CDATA[recipe]]></destinationDB>
    <destinationTable><![CDATA[entries]]></destinationTable>
  </dst>
  <rule>
    <entry_id><![CDATA[]]></entry_id>
    <entry_name><![CDATA[$html = str_get_html($data);  
$result = $html->find("//h2[@class='page-header2']", 0)->plaintext;  
$result = strip_tags( $result, "<img><br/><br /><br><i><b><iframe>" );  
$result = str_replace( "'", "&quot;", $result );  
$result = str_replace( "'", "\'", $result );]]></entry_name>
    <entry_text><![CDATA[$parts = explode('/', $env['sourceUrl']); 
$result = $parts[ count($parts) - 1]; 
$parts = explode( '.',  $result ); 
$id = $parts[0];

$html = str_get_html($data); 

$div = $html->find( 'a[name=cutid1-end]', -1 );
if (isset($div)) {
   $div->outertext = '';
}
$imgs = $html->find( '//img.i-ljuser-userhead' );
foreach( $imgs as $k => $img ) {
 	$img->outertext = '';
}
$imgs = $html->find( '//img' );
foreach( $imgs as $k => $img ) {
    $parts = explode( "/", $img->src );
    $name = $parts[ count($parts) - 1 ];
    $img->src = "/public/images/$id/$name";
}

$result = $html->find("//div[@class='asset-body']", 0)->outertext;  
$result = strip_tags( $result, "<img><br/><br /><br><i><b><iframe>" );  
$result = str_replace( "'", "&quot;", $result );  
$result = str_replace( "'", "\'", $result );

]]></entry_text>
    <entry_ext_key><![CDATA[$parts = explode('/', $env['sourceUrl']); 
$result = $parts[ count($parts) - 1]; 
$parts = explode( '.',  $result ); 
$result = $parts[0];
$result = "greg-butcher-{$result}";]]></entry_ext_key>
    <entry_url><![CDATA[$result = $env['sourceUrl'];]]></entry_url>
  </rule>
  <key>
    <key_entry_id><![CDATA[false]]></key_entry_id>
    <key_entry_name><![CDATA[false]]></key_entry_name>
    <key_entry_text><![CDATA[false]]></key_entry_text>
    <key_entry_ext_key><![CDATA[true]]></key_entry_ext_key>
    <key_entry_url><![CDATA[false]]></key_entry_url>
  </key>
  <settings>
    <ruleTitle><![CDATA[Greg Butcher Entry]]></ruleTitle>
    <ruleCondition><![CDATA[$result = true;]]></ruleCondition>
    <ruleAfter><![CDATA[$result = true;

$parts = explode('/', $env['sourceUrl']); 
$result = $parts[ count($parts) - 1]; 
$parts = explode( '.',  $result ); 
$id = $parts[0];

$html = str_get_html($data);  
$imgs = $html->find( '//img' );
foreach( $imgs as $k => $img ) {
    $saveImage = ( '' !== trim($img->src) );
    $parts = explode( "/", $img->src );
    $name = $parts[ count($parts) - 1 ];
    $saveImage =$saveImage &&  (false === strpos( $img->src, "userinfo_" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "userpic" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "userhead" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "threadExpander" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "icons" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "www.livejournal.com" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "services.livejournal.com" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "scorecardresearch.com" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "counter.rambler.ru" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "counter.ru" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "mc.yandex.ru" ) );
    $saveImage =$saveImage &&  (false === strpos( $img->src, "awaps.yandex.ru" ) );

    if ($saveImage) {
           $new_dir = ROOT . "public/images/$id/";
           if (!file_exists($new_dir) ) { mkdir($new_dir); }
           $new_src = "{$new_dir}{$name}";
           file_put_contents($new_src , fopen($img->src ,'r'));
           error_log( $img->src  . " => " . $new_src );   
    }
}
]]></ruleAfter>
  </settings>
</root>
